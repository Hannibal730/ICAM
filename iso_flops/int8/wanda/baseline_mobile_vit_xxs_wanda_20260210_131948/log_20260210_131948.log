2026-02-10 13:19:48,150 - INFO - 로그 파일이 'log/Sewer-TAPNEW_flops/baseline_mobile_vit_xxs_wanda_20260210_131948/log_20260210_131948.log'에 저장됩니다.
2026-02-10 13:19:48,152 - INFO - ==================================================
2026-02-10 13:19:48,152 - INFO - config.yaml:
2026-02-10 13:19:48,152 - INFO - 
run:
  global_seed: 42
  cuda: true
  mode: inference
  pth_inference_dir: /home/user/workspace/CHOI/sewer_binary_cls_v9/log/Sewer-TAPNEW/iso_flops/fp32/wanda/baseline_mobile_vit_xxs_wanda_20260210_013821
  pth_best_name: best_model.pth
  evaluate_onnx: true
  only_inference: false
  use_int8_inference: true
  int8_calib_samples: 512
  int8_calibration_method: Percentile
  int8_activation_type: QUInt8
  int8_percentile: 99.99
  show_log: true
  dataset:
    name: Sewer-TAPNEW_flops
    type: image_folder
    train_split_ratio: 0.8
    paths:
      train_img_dir: /home/user/workspace/disk/nvme1/data/Sewer/Sewer-ML/train
      valid_img_dir: /home/user/workspace/disk/nvme1/data/Sewer/Sewer-ML/valid
      test_img_dir: /home/user/workspace/disk/nvme1/data/Sewer/Sewer-ML/valid
      train_csv: /home/user/workspace/disk/nvme1/data/Sewer/Sewer-ML/SewerML_Train.csv
      valid_csv: /home/user/workspace/disk/nvme1/data/Sewer/Sewer-ML/SewerML_Val.csv
      test_csv: /home/user/workspace/disk/nvme1/data/Sewer/Sewer-ML/SewerML_Val.csv
      img_folder: /home/user/workspace/disk/nvme1/data/Sewer/Sewer-TAPNEW
  random_sampling_ratio:
    train: 1.0
    valid: 1.0
    test: 1.0
  num_workers: 16
training_main:
  epochs: 90
  batch_size: 16
  pre_trained: false
  optimizer: adamw
  lr: 0.001
  weight_decay: 0.0001
  loss_function: CrossEntropyLoss
  label_smoothing: 0.1
  scheduler: cosineannealinglr
  scheduler_params:
    T_max: 90
    eta_min: 0.0001
  best_model_criterion: val_loss
training_baseline:
  epochs: 10
  batch_size: 16
  pre_trained: false
  optimizer: adamw
  lr: 0.001
  weight_decay: 0.0001
  loss_function: CrossEntropyLoss
  label_smoothing: 0.1
  scheduler: cosineannealinglr
  scheduler_params:
    T_max: 10
    eta_min: 0.0001
  best_model_criterion: val_loss
finetuning_pruned:
  epochs: 80
  batch_size: 16
  optimizer: adamw
  lr: 0.001
  weight_decay: 0.0001
  loss_function: CrossEntropyLoss
  label_smoothing: 0.1
  scheduler: cosineannealinglr
  scheduler_params:
    T_max: 80
    eta_min: 0.0001
  best_model_criterion: val_loss
model:
  img_size: 224
  num_patches_per_side: 7
  num_decoder_patches: 1
  num_decoder_layers: 6
  num_heads: 2
  cnn_feature_extractor:
    name: custom24
  encoder_dim: 24
  emb_dim: 24
  adaptive_initial_query: true
  decoder_ff_ratio: 2
  dropout: 0.1
  positional_encoding: true
  res_attention: false
  drop_path_ratio: 0.2
  save_attention: false
  num_plot_attention: 600
baseline:
  model_name: mobile_vit_xxs
  use_wanda_pruning: true
  num_wanda_calib_samples: 1353
  pruning_sparsity: 0.4786

2026-02-10 13:19:48,152 - INFO - ==================================================
2026-02-10 13:19:48,184 - INFO - CUDA 사용 가능. GPU 사용을 시작합니다. (Device: NVIDIA GeForce RTX 5090)
2026-02-10 13:19:48,184 - INFO - 'Sewer-TAPNEW_flops' 데이터 로드를 시작합니다 (Type: image_folder).
2026-02-10 13:19:48,184 - INFO - '/home/user/workspace/disk/nvme1/data/Sewer/Sewer-TAPNEW' 경로의 데이터를 훈련/테스트셋으로 분할합니다.
2026-02-10 13:19:48,188 - INFO - 총 1692개 데이터를 훈련용 1353개, 테스트용 339개로 분할합니다 (split_seed=42).
2026-02-10 13:19:48,188 - INFO - 데이터셋 클래스: ['abnormal', 'normal'] (총 2개)
2026-02-10 13:19:48,188 - INFO - 훈련 데이터: 1353개, 검증 데이터: 339개, 테스트 데이터: 339개
2026-02-10 13:19:48,188 - INFO - Baseline 모델 'mobile_vit_xxs'을(를) 생성합니다 (사전 훈련 가중치: 미사용).
2026-02-10 13:19:48,290 - INFO - timm 모델(mobile_vit_xxs)의 Attention.forward를 Pruning 호환성을 위해 Monkey-patching 합니다.
2026-02-10 13:19:48,296 - INFO - ==================================================
2026-02-10 13:19:48,296 - INFO - 모델 파라미터 수:
2026-02-10 13:19:48,296 - INFO -   - 총 파라미터: 951,666 개
2026-02-10 13:19:48,296 - INFO -   - 학습 가능한 파라미터: 951,666 개
2026-02-10 13:19:48,297 - INFO - '/home/user/workspace/CHOI/sewer_binary_cls_v9/log/Sewer-TAPNEW/iso_flops/fp32/wanda/baseline_mobile_vit_xxs_wanda_20260210_013821/pruning_info.yaml'에서 Pruning 희소도(0.4786)를 불러왔습니다.
2026-02-10 13:19:48,297 - INFO - 추론 모드: 훈련된 모델의 Pruning 구조를 재현합니다.
2026-02-10 13:19:48,297 - INFO - Wanda Pruning을 시작합니다.
2026-02-10 13:19:48,297 - INFO - Wanda 중요도 계산을 위해 Calibration을 수행합니다.
2026-02-10 13:19:48,298 - INFO -   - Calibration Samples: 1353 (approx 85 batches)
2026-02-10 13:19:51,067 - INFO - 분류 레이어 'ClassifierHead'을(를) Pruning 대상에서 제외합니다.
2026-02-10 13:19:51,067 - INFO - ViT 계열 모델의 모든 qkv 레이어를 Pruning 대상에서 제외합니다.
2026-02-10 13:19:51,364 - INFO - torch-pruning 완료. 모델 구조가 희소도(0.47856445312499996)에 맞춰 변경되었습니다.
2026-02-10 13:19:51,364 - INFO - ==================================================
2026-02-10 13:19:51,365 - INFO - ==================================================
2026-02-10 13:19:51,365 - INFO - 모델 파라미터 수:
2026-02-10 13:19:51,365 - INFO -   - 총 파라미터: 320,501 개
2026-02-10 13:19:51,365 - INFO -   - 학습 가능한 파라미터: 320,501 개
2026-02-10 13:19:51,365 - INFO - ==================================================
2026-02-10 13:19:51,365 - INFO - Inference 모드를 시작합니다.
2026-02-10 13:19:51,592 - INFO - [Model Load] PyTorch 모델 가중치 로드 중 피크 메모리 - 모델 로드 전 청소 직후 메모리: 0.38 MB
2026-02-10 13:19:51,592 - INFO - '/home/user/workspace/CHOI/sewer_binary_cls_v9/log/Sewer-TAPNEW/iso_flops/fp32/wanda/baseline_mobile_vit_xxs_wanda_20260210_013821/best_model.pth' 가중치 로드 완료.
2026-02-10 13:19:51,686 - INFO - 연산량 (MACs): 0.0912 GMACs per sample
2026-02-10 13:19:51,686 - INFO - 연산량 (FLOPs): 0.1824 GFLOPs per sample
2026-02-10 13:19:51,686 - INFO - ==================================================
2026-02-10 13:19:51,686 - INFO - INT8 Static Quantization (ONNX)을 적용합니다.
2026-02-10 13:19:52,168 - INFO - Quantization 전처리를 수행합니다 (Fusion, Shape Inference)...
2026-02-10 13:19:52,169 - INFO - Performing symbolic shape inference...
2026-02-10 13:19:52,291 - INFO - Calibration 진행 (512 samples)...
2026-02-10 13:19:52,291 - INFO - Calibration Method: percentile (CalibrationMethod.Percentile)
2026-02-10 13:19:52,291 - INFO - Activation Type: QUInt8 (Extra Options: {'Percentile': 99.99})
2026-02-10 13:20:24,969 - WARNING - Axis 1 is out-of-range for weight 'stages.2.1.transformer.0.norm1.weight' with rank 1
2026-02-10 13:20:24,970 - WARNING - Axis 1 is out-of-range for weight 'stages.2.1.transformer.0.norm2.weight' with rank 1
2026-02-10 13:20:24,971 - WARNING - Axis 1 is out-of-range for weight 'stages.2.1.transformer.1.norm1.weight' with rank 1
2026-02-10 13:20:24,972 - WARNING - Axis 1 is out-of-range for weight 'stages.2.1.transformer.1.norm2.weight' with rank 1
2026-02-10 13:20:24,973 - WARNING - Axis 1 is out-of-range for weight 'stages.2.1.norm.weight' with rank 1
2026-02-10 13:20:24,974 - WARNING - Axis 1 is out-of-range for weight 'stages.3.1.transformer.0.norm1.weight' with rank 1
2026-02-10 13:20:24,976 - WARNING - Axis 1 is out-of-range for weight 'stages.3.1.transformer.0.norm2.weight' with rank 1
2026-02-10 13:20:24,976 - WARNING - Axis 1 is out-of-range for weight 'stages.3.1.transformer.1.norm1.weight' with rank 1
2026-02-10 13:20:24,978 - WARNING - Axis 1 is out-of-range for weight 'stages.3.1.transformer.1.norm2.weight' with rank 1
2026-02-10 13:20:24,978 - WARNING - Axis 1 is out-of-range for weight 'stages.3.1.transformer.2.norm1.weight' with rank 1
2026-02-10 13:20:24,979 - WARNING - Axis 1 is out-of-range for weight 'stages.3.1.transformer.2.norm2.weight' with rank 1
2026-02-10 13:20:24,980 - WARNING - Axis 1 is out-of-range for weight 'stages.3.1.transformer.3.norm1.weight' with rank 1
2026-02-10 13:20:24,981 - WARNING - Axis 1 is out-of-range for weight 'stages.3.1.transformer.3.norm2.weight' with rank 1
2026-02-10 13:20:24,982 - WARNING - Axis 1 is out-of-range for weight 'stages.3.1.norm.weight' with rank 1
2026-02-10 13:20:24,984 - WARNING - Axis 1 is out-of-range for weight 'stages.4.1.transformer.0.norm1.weight' with rank 1
2026-02-10 13:20:24,985 - WARNING - Axis 1 is out-of-range for weight 'stages.4.1.transformer.0.norm2.weight' with rank 1
2026-02-10 13:20:24,986 - WARNING - Axis 1 is out-of-range for weight 'stages.4.1.transformer.1.norm1.weight' with rank 1
2026-02-10 13:20:24,987 - WARNING - Axis 1 is out-of-range for weight 'stages.4.1.transformer.1.norm2.weight' with rank 1
2026-02-10 13:20:24,988 - WARNING - Axis 1 is out-of-range for weight 'stages.4.1.transformer.2.norm1.weight' with rank 1
2026-02-10 13:20:24,989 - WARNING - Axis 1 is out-of-range for weight 'stages.4.1.transformer.2.norm2.weight' with rank 1
2026-02-10 13:20:24,990 - WARNING - Axis 1 is out-of-range for weight 'stages.4.1.norm.weight' with rank 1
2026-02-10 13:20:25,592 - INFO - ONNX INT8 모델 저장 완료: log/Sewer-TAPNEW_flops/baseline_mobile_vit_xxs_wanda_20260210_131948/best_model_int8.onnx
2026-02-10 13:20:25,774 - INFO - [Model Load] ONNX 모델(INT8) 로드 중 피크 메모리 - 모델 로드 전 청소 직후 메모리: 6.94 MB
2026-02-10 13:20:25,774 - INFO - ONNX 런타임의 샘플 당 Forward Pass 시간 측정을 시작합니다...
2026-02-10 13:20:26,311 - INFO - 샘플 당 평균 Forward Pass 시간 (ONNX, CPU): 3.80ms (std: 0.11ms)
2026-02-10 13:20:26,311 - INFO - 샘플 당 평균 FPS (ONNX, CPU): 263.09 FPS (std: 6.39) (1개 샘플 x 100회 반복)
2026-02-10 13:20:26,311 - INFO - [Inference] 추론 중 피크 메모리 - 모델 로드 후 메모리 정리 직후 메모리: 6.38 MB
2026-02-10 13:20:26,311 - INFO - [Total] (INT8) 추론 중 피크 메모리 - 모델 로드 전 청소 직후 메모리: 14.47 MB
2026-02-10 13:20:27,875 - INFO - [Inference (ONNX INT8)] | Test Acc (ONNX): 83.19%
2026-02-10 13:20:27,882 - INFO - [Metrics for 'abnormal' (ONNX)] | Precision: 0.8165 | Recall: 0.8217 | F1: 0.8190
2026-02-10 13:20:27,882 - INFO - [Metrics for 'normal' (ONNX)] | Precision: 0.8453 | Recall: 0.8407 | F1: 0.8430
2026-02-10 13:20:28,012 - INFO - ==================================================
2026-02-10 13:20:28,012 - INFO - 혼동 행렬 저장 완료. 'log/Sewer-TAPNEW_flops/baseline_mobile_vit_xxs_wanda_20260210_131948/confusion_matrix_20260210_131948.png' and 'log/Sewer-TAPNEW_flops/baseline_mobile_vit_xxs_wanda_20260210_131948/confusion_matrix_20260210_131948.pdf'
